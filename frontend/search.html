<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <title>bfd search</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Oswald|Playfair+Display|Nunito:300" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/corejs-typeahead/1.2.1/typeahead.jquery.min.js"></script>
  <style>
  /*css*/
  </style>
</head>
<body>
    <form id="search-bfd-form">
        <span id="fixed-text">
          <!-- text dynamically added here -->
        </span>
        <span id="the-basics">
          <input class="typeahead" type="text" placeholder="start typing your search...">
          <button id="reset-query-btn" type="button">Reset</button>
          <button id="search-bfd-btn" type="button">Done</button>
        </span>
    </form>
    <div id='query-results-container'>

    </div>
<script>
$(function() {

    var substringMatcher = function(strs) {
      return function findMatches(q, cb) {
        var matches, substringRegex;

        // an array that will be populated with substring matches
        matches = [];

        // regex used to determine if a string contains the substring `q`
        substrRegex = new RegExp(q, 'i');

        // iterate through the pool of strings and for any string that
        // contains the substring `q`, add it to the `matches` array
        $.each(strs, function(i, str) {
          if (substrRegex.test(str.slice(0,q.length))) {
            matches.push(str);
          }
        });

        cb(matches);
      };
    };

    function setDropdownOptions(options) {
      $("#the-basics .typeahead").typeahead("destroy");
      $('#the-basics .typeahead').typeahead({
          hint: true,
          highlight: true,
          minLength: 0,
        },
        {
          name: 'options',
          limit: 5,
          source: substringMatcher(options),
        });
    }

    function getOptionsToDisplay(selectedText, setDropdownOptions) {
      $.ajax({
            type: 'POST',
            url: "http://localhost:5000/get_options",
            data: {"search_text": selectedText},
            success: function(response) {
                console.log(response);
                setDropdownOptions(JSON.parse(response))
            },
            error: function(error) {
                console.log(error)
            }
        });
    }

    $('#search-bfd-btn').click(function(e) {
        $.ajax({
            type: 'POST',
            url: "http://localhost:5000/run_query",
            success: function(response) {
                e.preventDefault()
                console.log(JSON.parse(response));
                // $('#query-results-container').append( "<p>Got a result</p>" );
            },
            error: function(error) {
                console.log("ERROR")
                console.log(error)
            }
        });
    });

    $('#reset-query-btn').click(function(e) {
      $.ajax({
          type: 'POST',
          url: "http://localhost:5000/reset_query",
          success: function(response) {
              e.preventDefault()
              console.log(JSON.parse(response));
              getOptionsToDisplay("origin", setDropdownOptions);
              $('#fixed-text').text("");
          },
          error: function(error) {
              console.log("ERROR")
              console.log(error)
          }
      });
    });

    // on page load
    getOptionsToDisplay("origin", setDropdownOptions);

    $('.typeahead').on('typeahead:selected', function(evt, item) {
      // add text to div before search box
      var currentFixedText = $('#fixed-text').text();
      $('#fixed-text').text(currentFixedText + " " + item);
      $('.typeahead').typeahead('val','')
 
      getOptionsToDisplay(item, setDropdownOptions);
  })



});
</script>
</body>
</html>
